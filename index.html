<!DOCTYPE html>
<html>
<head>
  <!-- Import Vega & Vega-Lite (does not have to be from CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5.22"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2"></script>
  <!-- Import vega-embed -->
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20"></script>
  <title>BQE Median Travel Time</title>
</head>
<body>

<div id="vis"></div>

<script type="text/javascript">
let spec = "bqe.vgl.json";

let yesterday = new Date();
yesterday.setTime(Date.now() - 24*60*60*1000);
// On Saturday and Monday, include all of yesterday.
if ([6, 1].includes((new Date()).getDay())) {
    yesterday.setHours(0);
    yesterday.setMinutes(0);
    yesterday.setSeconds(0);
}

let f = fetch("https://data.cityofnewyork.us/resource/i4gi-tjb9.json"
    + "?$limit=10000"
    + "&$order=data_as_of DESC"
    + "&$select=link_name,data_as_of,status,speed,travel_time"
    + "&$where=link_id in ('4616257', '4616339', '4616340', '4616229', '4616271', '4616223')"
    + "and status = '0' and data_as_of > "
    /*+ "'" + yesterday.toISOString().replace(/\..*Z/ig, '') + "'"*/
    + "'2022-06-12'"
).then(response => response.json());
let v = vegaEmbed('#vis', spec);
Promise.all([f, v]).then(a => {
    let view = a[1].view;
    let data = a[0].map(row => {
        let d = new Date(row.data_as_of + "Z");
        return {
            "h": new Date(1900, 0, 1, d.getHours(), d.getMinutes(), d.getSeconds(), 0),
            "ym": new Date(d.getFullYear(), d.getMonth(), d.getDate()),
            "weekend": [6, 0].includes(d.getDay()),
            "link_name": row.link_name,
            "speed_worst": row.speed,
            "travel_worst": row.travel_time,
            "speed_25": row.speed,
            "speed_50": row.speed,
            "speed_75": row.speed,
            "travel_25": row.travel_time,
            "travel_50": row.travel_time,
            "travel_75": row.travel_time
        }
    });
    view.insert("today", data);
    view.resize();
    console.log(data);
});
</script>
</body>
</html>
